#!/bin/bash

VALGRIND=1
if [ "$1" = "-v" ]; then
	VALGRIND=0
fi

make clean
make -j 4
if [ $VALGRIND = 1 ]; then
	valgrind --leak-check=full --suppressions=valgrind.supp --error-exitcode=1 ./test || exit 1
else
	./test || exit 1
fi

PIDS=""
for eee in AAAA BBBB CCCC DDDD; do
	if [ $VALGRIND = 1 ]; then
		valgrind --leak-check=full --error-exitcode=1 --log-file=${eee}.val --gen-suppressions=all \
			--suppressions=valgrind.supp ./testnet ${eee} > ${eee}.log &
		PIDS+=" $!"
	else
		./testnet ${eee} > ${eee}.log &
		PIDS+=" $!"
	fi
done

ERR=0
for P in $PIDS; do
	if ! wait $P; then
		ERR=1
	fi
done
if [ "$ERR" != 0 ]; then
	echo
	echo Erro de execução, checar logs.
	echo
else
	make coverage
fi
